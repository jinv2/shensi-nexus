<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deep Read | æ·±è¯»</title>
    
    <!-- 1. æ ·å¼åº“ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 2. Supabase -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <!-- 3. Google Gemini -->
    <script type="importmap">
      { "imports": { "@google/generative-ai": "https://esm.run/@google/generative-ai" } }
    </script>
    <!-- å­—ä½“ -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@300;600&display=swap" rel="stylesheet">

    <style>
        /* æ·±è¯» Â· ç´«ç½—å…°é£æ ¼ */
        body { 
            background: #0a0510; 
            color: #d8b4fe; 
            font-family: 'Noto Serif SC', serif; 
            overflow-x: hidden;
            transition: background 1s ease;
        }
        
        /* é˜…è¯»å®¹å™¨ */
        .reader-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 40px;
            min-height: 100vh;
            border-left: 1px solid #2e1065;
            border-right: 1px solid #2e1065;
            background: #0f0718;
            box-shadow: 0 0 50px rgba(139, 92, 246, 0.05);
        }

        /* ğŸŸ¢ ä¿®å¤ï¼šé«˜é€ç»ç’ƒå¢™ (åªæŒ¡æ“ä½œï¼Œä¸æŒ¡è§†çº¿) */
        #glass-wall { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            z-index: 999; 
            /* ä¿®æ”¹è¿™é‡Œï¼šé€æ˜åº¦ 0.1 (éå¸¸é€šé€)ï¼ŒåŠ ä¸€ç‚¹æ¨¡ç³Š */
            background: rgba(139, 92, 246, 0.05); 
            backdrop-filter: blur(2px);
            cursor: not-allowed; 
            display: block; /* é»˜è®¤æ˜¾ç¤º */
        }

        /* é”å®šçš„æ ‡è®° (å³ä¸Šè§’) */
        .lock-badge {
            position: absolute; top: 20px; right: 20px;
            border: 1px solid #8b5cf6; color: #8b5cf6;
            padding: 5px 15px; font-size: 12px; border-radius: 4px;
            background: rgba(0,0,0,0.8);
            pointer-events: none;
        }

        /* æ‹¦æˆªå¼¹çª— (ç‚¹å‡»ç»ç’ƒå¢™æ‰æ˜¾ç¤º) */
        #auth-modal { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            z-index: 1000; 
            background: rgba(10, 5, 16, 0.9); /* å¼¹çª—èƒŒæ™¯è¦æ·± */
            display: none; align-items: center; justify-content: center; 
        }

        .lock-card { border: 1px solid #8b5cf6; padding: 40px; text-align: center; max-width: 400px; background: #180828; box-shadow: 0 0 40px rgba(139, 92, 246, 0.2); }
        .btn-purple { background: #2e1065; color: #d8b4fe; border: 1px solid #8b5cf6; padding: 10px 30px; font-weight: bold; cursor: pointer; text-transform: uppercase; transition: 0.2s; letter-spacing: 2px; }
        .btn-purple:hover { background: #8b5cf6; color: #fff; box-shadow: 0 0 20px #8b5cf6; }

        /* è¾“å…¥åŒº */
        textarea {
            width: 100%; height: 200px;
            background: #180828; color: #e9d5ff;
            border: 1px dashed #581c87;
            padding: 20px;
            font-size: 16px;
            outline: none;
            resize: vertical;
            line-height: 1.8;
        }
        textarea:focus { border-color: #a855f7; }

        /* åˆ†æç»“æœå¡ç‰‡ */
        .insight-card {
            border-left: 3px solid #a855f7;
            background: rgba(168, 85, 247, 0.1);
            padding: 20px;
            margin-top: 30px;
            animation: fadeIn 1s;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* é€‰ä¸­æ–‡å­—çš„é«˜äº® */
        ::selection { background: #581c87; color: white; }
    </style>
</head>
<body>

    <!-- ğŸ›¡ï¸ ä¼šå‘˜ç»ç’ƒå¢™ (ç‚¹å‡»è§¦å‘å¼¹çª—) -->
    <div id="glass-wall" onclick="document.getElementById('auth-modal').style.display='flex'">
        <div class="lock-badge">ğŸ”’ æ¸¸å®¢é¢„è§ˆæ¨¡å¼</div>
    </div>

    <!-- æ‹¦æˆªå¼¹çª— -->
    <div id="auth-modal">
        <div class="lock-card">
            <h2 class="text-2xl font-bold mb-4 tracking-widest text-purple-400">DEEP READ LOCKED</h2>
            <p class="text-xs mb-8 text-purple-300" style="line-height: 1.6;">
                æ·±åº¦é˜…è¯»ä¸ AI è§£æåŠŸèƒ½<br>
                ä»…å¯¹ <strong>ç¥æ€åº­ä¼šå‘˜</strong> å¼€æ”¾
            </p>
            <a href="https://shensi-nexus.vercel.app" class="btn-purple" style="text-decoration:none;">è·å–é€šè¡Œè¯</a>
            <div style="margin-top: 20px; font-size: 12px; color: #666; cursor: pointer;" onclick="document.getElementById('auth-modal').style.display='none'">[ ç»§ç»­é¢„è§ˆç•Œé¢ ]</div>
        </div>
    </div>

    <!-- é¡¶éƒ¨ -->
    <div class="fixed top-0 left-0 w-full p-4 flex justify-between items-center bg-opacity-90 bg-[#0a0510] z-50 border-b border-purple-900/30">
        <div>
            <h1 class="text-xl font-bold tracking-[0.2em] text-white">DEEP READ</h1>
            <p class="text-[10px] text-purple-500">AI IMMERSIVE READING TERMINAL</p>
        </div>
        <div class="text-[10px] text-purple-800 font-mono" id="user-status">WAITING LINK...</div>
    </div>

    <!-- ä¸»ç•Œé¢ -->
    <div class="reader-container mt-16">
        
        <!-- 1. è¾“å…¥æ¨¡å¼ -->
        <div id="input-mode">
            <p class="text-xs text-purple-500 mb-4 tracking-widest uppercase text-center">- Input Text Source -</p>
            <textarea id="text-input" placeholder="åœ¨æ­¤ç²˜è´´æ–‡ç« ã€å°è¯´ç‰‡æ®µæˆ–å“²å­¦æ–‡æœ¬...&#10;&#10;AI å°†ä¸ºæ‚¨è¿›è¡Œæ·±åº¦è§£æã€æƒ…ç»ªæ¸²æŸ“ä¸æ½œå°è¯æŒ–æ˜ã€‚"></textarea>
            
            <div class="flex justify-center mt-6">
                <button onclick="enterReadMode()" class="btn-purple">
                    ENTER DEEP READING
                </button>
            </div>
        </div>

        <!-- 2. é˜…è¯»æ¨¡å¼ (é»˜è®¤éšè—) -->
        <div id="read-mode" class="hidden">
            <div class="flex justify-between mb-8 text-xs text-purple-600 border-b border-purple-900/30 pb-2">
                <span onclick="exitReadMode()" class="cursor-pointer hover:text-white">&larr; BACK TO EDIT</span>
                <span>AI ANALYSIS READY</span>
            </div>

            <!-- æ­£æ–‡æ˜¾ç¤ºåŒº -->
            <div id="article-content" class="text-lg leading-relaxed text-gray-300 mb-12" onmouseup="checkSelection()"></div>

            <!-- AI ä¾§è¾¹æ /åº•éƒ¨æ  -->
            <div id="ai-panel" class="hidden">
                <div class="flex items-center gap-2 mb-2">
                    <div class="w-2 h-2 bg-purple-500 rounded-full animate-pulse"></div>
                    <span class="text-xs font-bold text-purple-400 tracking-widest">GEMINI INSIGHT</span>
                </div>
                <div id="ai-content" class="insight-card text-sm text-purple-200 font-sans">
                    Thinking...
                </div>
            </div>

            <!-- å…¨æ–‡åˆ†ææŒ‰é’® -->
            <div class="text-center mt-16 border-t border-purple-900/30 pt-8">
                <button onclick="analyzeFullText()" id="analyze-btn" class="text-xs text-purple-500 hover:text-white border border-purple-800 px-4 py-2 rounded hover:bg-purple-900 transition">
                    âš¡ ANALYZE FULL TEXT STRUCTURE
                </button>
            </div>
        </div>

    </div>

    <!-- ğŸ§  é€»è¾‘æ ¸å¿ƒ -->
    <script type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";

        // ================= é…ç½®åŒº =================
        const APP_SLUG = 'shensi-read'; 
        const SB_URL = 'https://enutekcevqcmhrzwdnlt.supabase.co';
        const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVudXRla2NldnFjbWhyendkbmx0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY3ODg1MjAsImV4cCI6MjA4MjM2NDUyMH0.WrZ3sRH-0HVXv5NNPTvm00l5kC4qURAaxq0jinxND3E';
        // ğŸ”‘ ä½ çš„ Google Key
        const GEMINI_KEY = 'AIzaSyAAilSsHdHTUseTZYxw-Wp0H9dtH-F_zpc'; 
        // =========================================

        let fullText = "";

        // 1. é‰´æƒ
        (async function initAuth() {
            try {
                const sb = supabase.createClient(SB_URL, SB_KEY);
                const { data: { session } } = await sb.auth.getSession();
                if (session) {
                    document.getElementById('glass-wall').style.display = 'none';
                    document.getElementById('user-status').innerText = "LINKED: " + session.user.email;
                }
            } catch (e) { console.error("Auth Error", e); }
        })();

        // 2. æ¨¡å¼åˆ‡æ¢
        window.enterReadMode = () => {
            const text = document.getElementById('text-input').value;
            if(!text) return alert("è¯·è¾“å…¥æ–‡æœ¬");
            
            fullText = text;
            // ç®€å•çš„æ ¼å¼åŒ–ï¼šæ¢è¡Œè½¬æ®µè½
            const html = text.split('\n').map(p => p.trim() ? `<p class="mb-4">${p}</p>` : '').join('');
            
            document.getElementById('article-content').innerHTML = html;
            document.getElementById('input-mode').classList.add('hidden');
            document.getElementById('read-mode').classList.remove('hidden');
            window.scrollTo(0,0);
        }

        window.exitReadMode = () => {
            document.getElementById('input-mode').classList.remove('hidden');
            document.getElementById('read-mode').classList.add('hidden');
            document.getElementById('ai-panel').classList.add('hidden');
        }

        // 3. é€‰ä¸­æ–‡æœ¬è§¦å‘ AI
        window.checkSelection = async () => {
            const selection = window.getSelection();
            const selectedText = selection.toString().trim();
            
            if (selectedText.length > 5) {
                // æ˜¾ç¤ºé¢æ¿
                const panel = document.getElementById('ai-panel');
                const content = document.getElementById('ai-content');
                panel.classList.remove('hidden');
                content.innerHTML = "Analyzing selection...";
                
                try {
                    const genAI = new GoogleGenerativeAI(GEMINI_KEY);
                    const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });

                    const prompt = `
                        Analyze the following text selection from a literary perspective.
                        1. Explain the subtext or hidden meaning.
                        2. Identify the emotional tone.
                        3. If there are metaphors, explain them.
                        
                        Keep it concise (under 100 words). Use HTML formatting (<b>, <br>).
                        
                        Text: "${selectedText}"
                    `;

                    const result = await model.generateContent(prompt);
                    const response = await result.response;
                    content.innerHTML = response.text();

                } catch (error) {
                    console.error(error);
                    content.innerText = "AI Connection Failed.";
                }
            }
        };

        // 4. å…¨æ–‡åˆ†æ
        window.analyzeFullText = async () => {
            const btn = document.getElementById('analyze-btn');
            const panel = document.getElementById('ai-panel');
            const content = document.getElementById('ai-content');
            
            btn.innerText = "READING...";
            btn.disabled = true;
            panel.classList.remove('hidden');
            content.innerHTML = "Scanning full text structure...";

            try {
                const genAI = new GoogleGenerativeAI(GEMINI_KEY);
                const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });

                const prompt = `
                    Analyze this entire text.
                    Provide a "Literary Report":
                    1. Core Theme (ä¸€å¥è¯æ€»ç»“æ ¸å¿ƒæ€æƒ³)
                    2. Tone Analysis (æ•´ä½“åŸºè°ƒ)
                    3. Key Keywords (5ä¸ªå…³é”®è¯)
                    4. Reading Suggestion (è¯»è€…åº”è¯¥å¸¦ç€ä»€ä¹ˆé—®é¢˜å»è¯»)

                    Output as HTML.
                    
                    Text: ${fullText.substring(0, 5000)} ... (truncated if too long)
                `;

                const result = await model.generateContent(prompt);
                const response = await result.response;
                content.innerHTML = response.text();
                
                btn.innerText = "ANALYSIS COMPLETE";

            } catch (error) {
                console.error(error);
                content.innerText = "Full text analysis failed.";
            }
        };
    </script>
</body>
</html>
